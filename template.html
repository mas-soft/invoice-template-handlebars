<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Handlebars Playground</title>
    <script src="./handlebars.min.js"></script>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
          sans-serif, sans-serif;
        margin: 20px;
        text-align: center;
      }

      textarea {
        width: 100%;
        height: 100px;
        margin-bottom: 10px;
        text-align: center;
      }

      #preview {
        border: 1px solid #ddd;
        padding: 10px;
        width: 4in;
        font-size: 6px;
        text-align: center;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <h2>Handlebars Playground</h2>
    <button
      style="
        padding: 12px;
        background-color: chocolate;
        color: white;
        cursor: pointer;
        font-weight: bold;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue',
          sans-serif;
      "
      onclick="renderTemplate()"
    >
      عرض التقارير
    </button>
    <h3>Preview</h3>
    <div id="preview"></div>

    <script>
      async function renderTemplate() {
        const responseDb = await fetch("./db.json");
        const dataSource = await responseDb.json();
        const responseTemplateSource = await fetch("./receipt.json");
        const templateSource = await responseTemplateSource.text();

        // Get the template and data
        const previewDiv = document.getElementById("preview");
        previewDiv.innerHTML = ""; // Clear previous content

        function createElement(tag, content, styles) {
          const el = document.createElement(tag);
          if (content) el.innerHTML = content;
          if (styles) {
            Object.assign(el.style, styles);
          }
          return el;
        }

        function renderElement(element) {
          if (element.tag === "text") {
            const styles = {
              fontSize: element.fontSize ? `initial` : "initial",
              textAlign: element.textAlign || "center",
              textDecoration: element.invert ? "inverse" : "initial",
            };
            return createElement("p", element.value, styles);
          }

          if (element.tag === "space") {
            return createElement("div", "", {
              height: `${element.fontSize * 0.5}px`,
            });
          }

          if (element.tag === "line") {
            return createElement("hr", "", {
              borderWidth: `${element.stroke * 0.2}px`,
              borderColor: "#000",
              borderStyle: "solid",
            });
          }

          if (element.tag === "group") {
            const groupEl = createElement("div");
            groupEl.style.display = "flex";
            groupEl.style.justifyContent = "space-between";
            element.elements.forEach((childElement) => {
              groupEl.appendChild(renderElement(childElement));
            });
            return groupEl;
          }
        }

        Handlebars.registerHelper("loud", function (aString) {
          return aString.toUpperCase();
        });

        Handlebars.registerHelper("sum", function () {
          let base = 0;
          for (let i = 0; i < arguments.length - 1; i++) {
            if (arguments[i]) {
              let nm = Number(arguments[i]);
              if (nm && !isNaN(nm)) {
                base += Number(arguments[i]);
              }
            }
          }
          return base;
        });

        Handlebars.registerHelper(
          "math",
          function (lvalue, operator, rvalue, options) {
            lvalue = parseFloat(lvalue);
            rvalue = parseFloat(rvalue);

            return {
              "+": lvalue + rvalue,
              "-": lvalue - rvalue,
              "*": lvalue * rvalue,
              "/": lvalue / rvalue,
              "%": lvalue % rvalue,
            }[operator];
          }
        );

        Handlebars.registerHelper("view", function () {
          let txt = "";
          try {
            Object.keys(this).forEach((k) => {
              txt = txt + " " + k + ":" + this[k];
            });
          } catch (ex) {
            txt = this.toString ? this.toString() : "error";
          }
          return txt;
        });

        Handlebars.registerHelper("date", function (dat) {
          if (dat && dat?.getFullYear) {
            return dat?.getFullYear() + "-" + (1 + dat?.getMonth());
          }
          return dat;
        });

        Handlebars.registerHelper("length", function (dat) {
          return dat?.length || 0;
        });

        Handlebars.registerHelper("round", function (dat, dec) {
          if (!dec || dec <= 0) {
            return Math.round(dat);
          }
          let power = 10 ^ dec;
          let ret = Math.round(power * dat) / power;
          return ret || 0;
        });

        Handlebars.registerHelper("string", function (itm) {
          let ret = "";
          try {
            ret = JSON.stringify(itm);
            ret = ret.replace("quot", " ");
            ret = ret.replace("&", " ");
            ret = ret.replace(":", " ");
          } catch (ex) {
            ret = ex.toString ? ex.toString() : "error";
          }
          return ret || "";
        });

        // Compile the template
        try {
          const template = Handlebars.compile(templateSource);
          // Parse the JSON data
          const data = dataSource;

          // Render the template with the data
          const compiledHtml = template(data);

          console.log(compiledHtml, "compiledHtml");
          const parseTemplate = JSON.parse(compiledHtml);

          // Display the compiled HTML in the preview
          function render() {
            parseTemplate.elements.forEach((element) => {
              previewDiv.appendChild(renderElement(element));
            });
          }

          render();
        } catch (e) {
          alert(e);
          throw new Error(e);
        }
      }
    </script>
  </body>
</html>
